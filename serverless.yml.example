service: hakopita-fast-api

frameworkVersion: '3'

provider:
  name: aws
  runtime: python3.11
  region: ap-northeast-1
  memorySize: 512
  timeout: 30
  environment:
    # 環境変数を設定（実際の値はAWS Systems Manager Parameter Storeから取得することを推奨）
    DB_HOST: ${ssm:/hakopita/db_host}
    DB_PORT: ${ssm:/hakopita/db_port}
    DB_USER: ${ssm:/hakopita/db_user}
    DB_PASS: ${ssm:/hakopita/db_pass}
    DB_NAME: ${ssm:/hakopita/db_name}
    API_PREFIX: /v1_0
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - ssm:GetParameter
            - ssm:GetParameters
          Resource: 
            - "arn:aws:ssm:${self:provider.region}:*:parameter/hakopita/*"

functions:
  api:
    handler: lambda_handler.lambda_handler
    events:
      - httpApi:
          path: /{proxy+}
          method: ANY
    environment:
      # 環境別の設定
      ENV: prod
    vpc:
      securityGroupIds:
        - ${ssm:/hakopita/security_group_id}
      subnetIds:
        - ${ssm:/hakopita/subnet_id_1}
        - ${ssm:/hakopita/subnet_id_2}

plugins:
  - serverless-python-requirements

custom:
  pythonRequirements:
    dockerizePip: true
    layer:
      name: python-deps
      description: Python dependencies for hakopita-fast-api
    noDeploy:
      - coverage
      - pytest
      - black
      - isort
      - flake8 